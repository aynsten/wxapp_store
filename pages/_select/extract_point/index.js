const App = getApp(); import Toptips from '../../../components/toptips/toptips'; Page({ data: { selectedId: -1, isAuthor: true, isLoading: true, shopList: [] }, onLoad(options) { let _this = this; _this.setData({ selectedId: options.selected_id }); _this.getShopList(); _this.getLocation((res) => { _this.getShopList(res.longitude, res.latitude) }) }, getShopList(longitude, latitude) { let _this = this; _this.setData({ isLoading: true }); App._get('shop/lists', { longitude: longitude || '', latitude: latitude || '' }, (result) => { _this.setData({ shopList: result.data.list, isLoading: false }) }) }, getLocation(callback) { let _this = this; wx.getLocation({ type: 'wgs84', success(res) { callback && callback(res) }, fail() { Toptips({ duration: 3000, content: '获取定位失败，请点击右下角按钮打开定位权限' }); _this.setData({ isAuthor: false }) }, }) }, onAuthorize() { let _this = this; wx.openSetting({ success(res) { if (res.authSetting["scope.userLocation"]) { _this.setData({ isAuthor: true }); setTimeout(() => { _this.getLocation((res) => { _this.getShopList(res.longitude, res.latitude) }) }, 1000) } } }) }, onSelectedShop(e) { let _this = this, selectedId = e.currentTarget.dataset.id; _this.setData({ selectedId }); let pages = getCurrentPages(); if (pages.length < 2) { return false } let prevPage = pages[pages.length - 2]; prevPage.setData({ selectedShopId: selectedId }); wx.navigateBack({ delta: 1 }) }, })