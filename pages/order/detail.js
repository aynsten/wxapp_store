const App = getApp(); import DeliveryTypeEnum from '../../utils/enum/DeliveryType.js'; import PayTypeEnum from '../../utils/enum/order/PayType';Page({ data: { DeliveryTypeEnum, PayTypeEnum, order_id: null, order: {}, }, onLoad(options) { let _this = this; _this.data.order_id = options.order_id; _this.getOrderDetail(options.order_id) }, getOrderDetail(order_id) { let _this = this; App._get('user.order/detail', { order_id }, result => { _this.setData(result.data) }) }, onTargetGoods(e) { let goods_id = e.currentTarget.dataset.id; wx.navigateTo({ url: '../goods/index?goods_id=' + goods_id }) }, cancelOrder(e) { let _this = this; let order_id = _this.data.order_id; wx.showModal({ title: "提示", content: "确认取消订单？", success(o) { if (o.confirm) { App._post_form('user.order/cancel', { order_id }, result => { wx.navigateBack() }) } } }) }, receipt(e) { let _this = this; let order_id = _this.data.order_id; wx.showModal({ title: "提示", content: "确认收到商品？", success(o) { if (o.confirm) { App._post_form('user.order/receipt', { order_id }, result => { _this.getOrderDetail(order_id) }) } } }) }, onApplyRefund(e) { wx.navigateTo({ url: './refund/apply/apply?order_goods_id=' + e.currentTarget.dataset.id, }) }, onTargetShop(e) { wx.navigateTo({ url: '../shop/detail/index?shop_id=' + e.currentTarget.dataset.id, }) }, onPayOrder(e) { let _this = this; _this.onTogglePayPopup() }, onSelectPayType(e) { let _this = this; App.saveFormId(e.detail.formId); _this.onTogglePayPopup(); if (!_this.data.showPayPopup) { _this.payment(e.currentTarget.dataset.value) } }, onTogglePayPopup() { this.setData({ showPayPopup: !this.data.showPayPopup }) }, payment(payType) { let _this = this, orderId = _this.data.order_id; wx.showLoading({ title: '正在处理...', }); App._post_form('user.order/pay', { order_id: orderId, payType }, result => { if (result.code === -10) { App.showError(result.msg); return false } if (result.data.pay_type == PayTypeEnum.WECHAT.value) { App.wxPayment({ payment: result.data.payment, success() { _this.getOrderDetail(orderId) }, fail() { App.showError(result.msg.success) }, }) } if (result.data.pay_type == PayTypeEnum.BALANCE.value) { App.showSuccess(result.msg.success, () => { _this.getOrderDetail(orderId) }) } }, null, () => { wx.hideLoading() }) }, });