const App = getApp(); const pageIndex = 'category/list::'; Page({ data: { scrollHeight: null, showView: false, sortType: 'all', sortPrice: false, option: {}, list: {}, no_more: false, isLoading: true, page: 1, }, onLoad(option) { let _this = this; _this.setListHeight(); _this.setData({ option }); _this.setShowView(); _this.getGoodsList() }, setShowView() { let _this = this; _this.setData({ showView: wx.getStorageSync(pageIndex + 'showView') || false }) }, getGoodsList(isPage, page) { let _this = this; App._get('goods/lists', { page: page || 1, sortType: this.data.sortType, sortPrice: this.data.sortPrice ? 1 : 0, category_id: this.data.option.category_id || 0, search: this.data.option.search || '', }, result => { let resList = result.data.list, dataList = _this.data.list; if (isPage == true) { _this.setData({ 'list.data': dataList.data.concat(resList.data), isLoading: false, }) } else { _this.setData({ list: resList, isLoading: false, }) } }) }, setListHeight() { let _this = this; wx.getSystemInfo({ success: res => { _this.setData({ scrollHeight: res.windowHeight - 90, }) } }) }, switchSortType(e) { let _this = this, newSortType = e.currentTarget.dataset.type, newSortPrice = newSortType === 'price' ? !this.data.sortPrice : true; this.setData({ list: {}, isLoading: true, page: 1, sortType: newSortType, sortPrice: newSortPrice }, () => { _this.getGoodsList() }) }, onChangeShowState() { let _this = this, showView = !_this.data.showView; wx.setStorageSync(pageIndex + 'showView', showView); _this.setData({ showView }) }, bindDownLoad() { if (this.data.page >= this.data.list.last_page) { this.setData({ no_more: true }); return false } this.getGoodsList(true, ++this.data.page) }, onShareAppMessage() { return { title: "全部分类", path: "/pages/category/index?" + App.getShareUrlParams() } }, triggerSearch() { let pages = getCurrentPages(); if (pages.length > 1 && pages[pages.length - 2].route === 'pages/search/index') { wx.navigateBack(); return } wx.navigateTo({ url: '../search/index', }) }, });