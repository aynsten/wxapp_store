const App = getApp(); import util from '../../../utils/util.js'; import CountDown from '../../../utils/countdown.js'; import StateEnum from '../../../utils/enum/sharp/ActiveStatus.js'; Page({ data: { curTabIndex: 0, noMore: false, isLoading: true, page: 1, StateEnum, countDownList: [], tabbar: [], goodsList: [], test: {}, }, onLoad(options) { }, onShow() { let _this = this; _this.getApiData() }, getApiData() { let _this = this; App._get('sharp.index/index', {}, (result) => { _this.setData({ test: result.data }); _this.setData(result.data); _this._initCountDownData() }) }, _initCountDownData(data) { let _this = this, curTabbar = _this.data.tabbar[_this.data.curTabIndex]; _this.setData({ [`countDownList[0]`]: { date: curTabbar.count_down_time, } }); CountDown.onSetTimeList(_this, 'countDownList') }, onToggleTab(e) { let _this = this; App.saveFormId(e.detail.formId); _this.setData({ curTabIndex: e.detail.target.dataset.index, goodsList: [], page: 1, isLoading: true, noMore: false, }); _this.getGoodsList(); _this._initCountDownData() }, onTargetActive(e) { let _this = this, curTabbar = _this.data.tabbar[_this.data.curTabIndex]; App.saveFormId(e.detail.formId); let query = util.urlEncode({ active_time_id: curTabbar.active_time_id, sharp_goods_id: e.detail.target.dataset.id, }); wx.navigateTo({ url: `../goods/index?${query}`, }) }, onReachBottom() { let _this = this, listData = _this.data.goodsList; if (_this.data.page >= listData.last_page) { _this.setData({ noMore: true }); return false } _this.setData({ page: ++_this.data.page }); _this.getGoodsList(true) }, getGoodsList(isNextPage) { let _this = this, curTabbar = _this.data.tabbar[_this.data.curTabIndex]; App._get('sharp.goods/lists', { page: _this.data.page || 1, active_time_id: curTabbar.active_time_id }, (result) => { let resList = result.data.list, dataList = _this.data.goodsList; if (isNextPage == true) { _this.setData({ 'goodsList.data': dataList.data.concat(resList.data), isLoading: false, }) } else { _this.setData({ goodsList: resList, isLoading: false, }) } }) }, onShareAppMessage() { let _this = this; let params = App.getShareUrlParams(); return { title: '整点秒杀', path: `/pages/sharp/index/index?${params}` } }, })