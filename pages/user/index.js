const App = getApp(); Page({ data: { isLogin: false, userInfo: {}, orderCount: {}, couponCount: 0, userNewsNum: 0, refundCount: 0, }, onLoad: function (options) { }, onShow() { let _this = this; _this.setData({ isLogin: App.checkIsLogin() }); if (_this.data.isLogin) { _this.getUserDetail(); _this.getUserRefund() } }, getUserDetail() { let _this = this; App._get('user.index/detail', {}, function (result) { _this.setData(result.data); _this.updateUserNewsNum() }) }, getUserRefund() { let _this = this; let _refundCount = 0; App._get('user.refund/lists', {}, function (result) { for (var i = 0; i < result.data.list.data.length; i++) { if (result.data.list.data[i].is_agree.value == 0 || result.data.list.data[i].status.value == 0) { _refundCount = _refundCount + 1 } } _this.setData({ refundCount: _refundCount }) }) }, updateUserNewsNum() { let _this = this; let _userNewsNum = 0; if (_this.data.orderCount.payment > 0 || _this.data.orderCount.received > 0 || _this.data.refundCount > 0) { _userNewsNum = 1 } else { _userNewsNum = 0 } _this.setData({ userNewsNum: _userNewsNum }); wx.setStorageSync("userNewsNum", _userNewsNum) }, onTargetOrder(e) { let _this = this; if (!_this.onCheckLogin()) { return false } App.saveFormId(e.detail.formId); let urls = { all: '/pages/order/index?type=all', payment: '/pages/order/index?type=payment', received: '/pages/order/index?type=received', refund: '/pages/order/refund/index', }; wx.navigateTo({ url: urls[e.currentTarget.dataset.type] }) }, onTargetMenus(e) { let _this = this; if (!_this.onCheckLogin()) { return false } App.saveFormId(e.detail.formId); wx.navigateTo({ url: '/' + e.currentTarget.dataset.url }) }, onTargetWallet(e) { let _this = this; if (!_this.onCheckLogin()) { return false } App.saveFormId(e.detail.formId); wx.navigateTo({ url: './wallet/index' }) }, onTargetBlanceLog(e) { let _this = this; if (!_this.onCheckLogin()) { return false } App.saveFormId(e.detail.formId); wx.navigateTo({ url: './wallet/balance/log' }) }, onTargetPoints(e) { let _this = this; if (!_this.onCheckLogin()) { return false } App.saveFormId(e.detail.formId); wx.navigateTo({ url: '../points/log/index' }) }, onTargetCoupons(e) { let _this = this; if (!_this.onCheckLogin()) { return false } App.saveFormId(e.detail.formId); wx.navigateTo({ url: '../user/coupon/coupon' }) }, onLogin() { wx.navigateTo({ url: '../login/login', }) }, onCheckLogin() { let _this = this; if (!_this.data.isLogin) { App.showError('请先点击头像登录！'); return false } return true }, })