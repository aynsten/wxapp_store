const App = getApp(); import wxParse from '../../../wxParse/wxParse.js'; import util from '../../../utils/util.js'; import CountDown from '../../../utils/countdown.js'; import Dialog from '../../../components/dialog/dialog'; let goodsSpecArr = []; Page({ data: { indicatorDots: true, autoplay: true, interval: 3000, duration: 800, currentIndex: 1, floorstatus: false, detail: {}, goods_price: 0, line_price: 0, stock_num: 0, goods_num: 1, goods_sku_id: 0, cart_total_num: 0, goodsMultiSpec: {}, share: { show: false, cancelWithMask: true, cancelText: '关闭', actions: [{ name: '生成商品海报', className: 'action-class', loading: false }, { name: '发送给朋友', openType: 'share' }], showPopup: false, }, showTopWidget: false, actEndTimeList: [], active: {}, goods: {}, setting: {}, is_partake: false, task_id: false, }, onLoad(options) { let _this = this, scene = App.getSceneData(options); _this.setData({ active_id: options.active_id ? options.active_id : scene.aid }) }, onShow(options) { let _this = this; _this.getActiveDetail() }, getActiveDetail() { let _this = this; App._get('bargain.active/detail', { active_id: _this.data.active_id }, (result) => { let data = _this._initData(result.data); _this.setData(data); if (!data.active.is_end) { CountDown.onSetTimeList(_this, 'actEndTimeList') } }) }, _initData(data) { let _this = this; let goodsDetail = data.goods; if (goodsDetail.content.length > 0) { wxParse.wxParse('content', 'html', goodsDetail.content, _this, 0) } data.goods_sku_id = goodsDetail.goods_sku.spec_sku_id; data.goods_price = goodsDetail.goods_sku.goods_price; data.line_price = goodsDetail.goods_sku.line_price; data.stock_num = goodsDetail.goods_sku.stock_num; data.skuCoverImage = goodsDetail.goods_image; if (goodsDetail.spec_type == 20 && goodsDetail.goods_sku['image']) { data.skuCoverImage = goodsDetail.goods_sku['image']['file_path'] } if (goodsDetail.spec_type == 20) { data.goodsMultiSpec = _this._initManySpecData(goodsDetail.goods_multi_spec) } data.actEndTimeList = [{ date: data.active.end_time }]; return data }, _initManySpecData(data) { goodsSpecArr = []; for (let i in data.spec_attr) { for (let j in data.spec_attr[i].spec_items) { if (j < 1) { data.spec_attr[i].spec_items[0].checked = true; goodsSpecArr[i] = data.spec_attr[i].spec_items[0].item_id } } } return data }, onSwitchSpec(e) { let _this = this, attrIdx = e.currentTarget.dataset.attrIdx, itemIdx = e.currentTarget.dataset.itemIdx, goodsMultiSpec = _this.data.goodsMultiSpec; App.saveFormId(e.detail.formId); for (let i in goodsMultiSpec.spec_attr) { for (let j in goodsMultiSpec.spec_attr[i].spec_items) { if (attrIdx == i) { goodsMultiSpec.spec_attr[i].spec_items[j].checked = false; if (itemIdx == j) { goodsMultiSpec.spec_attr[i].spec_items[itemIdx].checked = true; goodsSpecArr[i] = goodsMultiSpec.spec_attr[i].spec_items[itemIdx].item_id } } } } _this.setData({ goodsMultiSpec }); _this._updateSpecGoods() }, _updateSpecGoods() { let _this = this, specSkuId = goodsSpecArr.join('_'); let spec_list = _this.data.goodsMultiSpec.spec_list, skuItem = spec_list.find((val) => { return val.spec_sku_id == specSkuId }); if (typeof skuItem === 'object') { _this.setData({ goods_sku_id: skuItem.spec_sku_id, goods_price: skuItem.form.goods_price, line_price: skuItem.form.line_price, stock_num: skuItem.form.stock_num, skuCoverImage: skuItem.form.image_id > 0 ? skuItem.form.image_path : _this.data.goods.goods_image }) } }, setCurrent(e) { let _this = this; _this.setData({ currentIndex: e.detail.current + 1 }) }, onPreviewImages(e) { let _this = this; let index = e.currentTarget.dataset.index, imageUrls = []; _this.data.goods.image.forEach(item => { imageUrls.push(item.file_path) }); wx.previewImage({ current: imageUrls[index], urls: imageUrls }) }, onPreviewSkuImage(e) { let _this = this; wx.previewImage({ current: _this.data.skuCoverImage, urls: [_this.data.skuCoverImage] }) }, onTargetToComment() { let _this = this; wx.navigateTo({ url: `../../goods/comment/comment?goods_id=${_this.data.goods.goods_id}` }) }, onScrollTop(t) { let _this = this; _this.setData({ scrollTop: 0 }) }, onScrollEvent(e) { let _this = this; _this.setData({ showTopWidget: e.detail.scrollTop > 200 }) }, onClickShare(e) { let _this = this; App.saveFormId(e.detail.formId); _this.setData({ 'share.show': true }) }, onCloseShare() { let _this = this; _this.setData({ 'share.show': false }) }, onClickShareItem(e) { let _this = this; if (e.detail.index === 0) { _this._showPoster() } _this.onCloseShare() }, onTogglePopup() { let _this = this; _this.setData({ 'share.showPopup': !_this.data.share.showPopup }) }, _showPoster() { let _this = this; wx.showLoading({ title: '加载中', }); App._get('bargain.active/poster', { active_id: _this.data.active_id }, (result) => { _this.setData(result.data, () => { _this.onTogglePopup() }) }, null, () => { wx.hideLoading() }) }, onSavePoster(e) { let _this = this; App.saveFormId(e.detail.formId); wx.showLoading({ title: '加载中', }); wx.downloadFile({ url: _this.data.qrcode, success(res) { wx.hideLoading(); wx.saveImageToPhotosAlbum({ filePath: res.tempFilePath, success(data) { wx.showToast({ title: '保存成功', icon: 'success', duration: 2000 }); _this.onTogglePopup() }, fail(err) { if (err.errMsg === 'saveImageToPhotosAlbum:fail auth deny') { wx.showToast({ title: "请允许访问相册后重试", icon: "none", duration: 1000 }); setTimeout(() => { wx.openSetting() }, 1000) } }, complete(res) { } }) } }) }, onToggleTrade(e) { let _this = this; if (typeof e === 'object') { e.detail.hasOwnProperty('formId') && App.saveFormId(e.detail.formId) } _this.setData({ showBottomPopup: !_this.data.showBottomPopup }) }, onToggleRules(e) { App.saveFormId(e.detail.formId); let _this = this; Dialog({ title: '砍价规则', message: _this.data.setting.bargain_rules, selector: '#zan-base-dialog', isScroll: true, buttons: [{ text: '关闭', color: 'red', type: 'cash' }] }) }, onSubmit(e) { let _this = this; App.saveFormId(e.detail.formId); if (_this.data.is_partake) { wx.navigateTo({ url: `../task/index?task_id=${_this.data.task_id}`, }); return } if (_this.data.goods.spec_type == 20) { _this.onToggleTrade(); return } _this.onCheckout() }, onSubmit2(e) { let _this = this; App.saveFormId(e.detail.formId); _this.onToggleTrade(); _this.onCheckout() }, onCheckout() { let _this = this; if (_this.data.disabled) { return false } wx.showLoading({ title: '正在处理...' }); App._post_form('bargain.task/partake', { active_id: _this.data.active_id, goods_sku_id: _this.data.goods_sku_id, }, result => { wx.navigateTo({ url: `../task/index?task_id=${result.data.task_id}` }) }, result => { }, () => { wx.hideLoading(); _this.data.disabled = false }) }, onTargetHome(e) { App.saveFormId(e.detail.formId); wx.switchTab({ url: '../../index/index', }) }, onShareAppMessage() { let _this = this; let params = App.getShareUrlParams({ active_id: _this.data.active.active_id }); return { title: _this.data.detail.goods_name, path: `/pages/bargain/goods/index?${params}` } }, })