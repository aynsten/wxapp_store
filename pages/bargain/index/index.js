const App = getApp(); import util from '../../../utils/util.js'; import CountDown from '../../../utils/countdown.js'; Page({ data: { currentTab: 0, scrollHeight: null, scrollTop: 0, noMore: false, isLoading: true, page: 1, countDownList: [], activeList: [], myList: [], }, onLoad(options) { let _this = this; _this._setListHeight(); _this._setCurrentTab(options) }, onShow() { let _this = this; if (_this.data.scrollTop == 0) { _this._getList() } }, _setCurrentTab(options) { let _this = this; if (options.hasOwnProperty('tab')) { _this.setData({ currentTab: options.tab }) } }, _setListHeight() { let _this = this; let systemInfo = wx.getSystemInfoSync(), rpx = systemInfo.windowWidth / 750, tapHeight = Math.floor(rpx * (92 + 20)), scrollHeight = systemInfo.windowHeight - tapHeight; _this.setData({ scrollHeight }) }, getActiveList(isPage) { let _this = this; App._get('bargain.active/lists', { page: _this.data.page || 1, }, (result) => { let resList = result.data.activeList, dataList = _this.data.activeList; if (isPage == true) { _this.setData({ 'activeList.data': dataList.data.concat(resList.data), isLoading: false, }) } else { _this.setData({ activeList: resList, isLoading: false, }) } }) }, getMyList(isPage) { let _this = this; App._get('bargain.task/lists', { page: _this.data.page || 1, }, (result) => { let resList = result.data.myList, dataList = _this.data.myList; if (isPage == true) { _this.setData({ 'myList.data': dataList.data.concat(resList.data), isLoading: false, }) } else { _this.setData({ myList: resList, isLoading: false, }) } _this._initCountDownData(result.data) }) }, _initCountDownData(data) { let _this = this; let countDownList = _this.data.countDownList; data.myList.data.forEach((item) => { countDownList.push({ date: item.end_time, }) }); _this.setData({ countDownList, }); if (countDownList.length > 0) { CountDown.onSetTimeList(_this, 'countDownList') } }, onScrollEvent(e) { let _this = this; _this.setData({ scrollTop: e.detail.scrollTop }) }, onToggleTab(e) { let _this = this; App.saveFormId(e.detail.formId); _this.setData({ currentTab: e.currentTarget.dataset.index, activeList: [], myList: [], page: 1, isLoading: true, noMore: false, }); _this._getList() }, onTargetActive(e) { App.saveFormId(e.detail.formId); wx.navigateTo({ url: `../goods/index?active_id=${e.detail.target.dataset.id}`, }) }, onTargetTask(e) { App.saveFormId(e.detail.formId); wx.navigateTo({ url: `../task/index?task_id=${e.detail.target.dataset.id}`, }) }, onScrollToLower() { let _this = this, listData = _this.data.currentTab == 0 ? _this.data.activeList : _this.data.myList; if (_this.data.page >= listData.last_page) { _this.setData({ noMore: true }); return false } _this.setData({ page: ++_this.data.page }); _this._getList(true) }, _getList(isPage) { let _this = this; _this.data.currentTab == 0 ? _this.getActiveList(isPage) : _this.getMyList(isPage) }, onShareAppMessage() { let _this = this; let params = App.getShareUrlParams(); return { title: '砍价专区', path: `/pages/bargain/index/index?${params}` } }, })