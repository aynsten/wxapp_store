const App = getApp(); Page({ data: { categoryList: [], goodsList: [], category_id: 0, scrollHeight: null, option: {}, list: {}, no_more: false, isLoading: true, page: 1, }, onLoad: function (options) { let _this = this; _this.setListHeight(); this.getIndexData() }, getIndexData() { let _this = this; App._get('sharing.index/index', {}, function (result) { _this.setData({ categoryList: result.data.categoryList }) }); _this.getGoodsList() }, onSwitchTab: function (e) { let _this = this; _this.setData({ category_id: e.currentTarget.dataset.id, goodsList: {}, page: 1, no_more: false, isLoading: true, }); _this.getGoodsList() }, getGoodsList(isPage, page) { let _this = this; App._get('sharing.goods/lists', { page: page || 1, category_id: _this.data.category_id }, function (result) { let resList = result.data.list, dataList = _this.data.goodsList; if (isPage == true) { _this.setData({ 'goodsList.data': dataList.data.concat(resList.data), isLoading: false, }) } else { _this.setData({ goodsList: resList, isLoading: false, }) } }) }, onTargetGoods(e) { wx.navigateTo({ url: '../goods/index?goods_id=' + e.currentTarget.dataset.id }) }, onShareAppMessage: function () { return { title: '拼团首页', path: "/pages/sharing/index/index?" + App.getShareUrlParams() } }, bindDownLoad: function () { if (this.data.page >= this.data.goodsList.last_page) { this.setData({ no_more: true }); return false } this.getGoodsList(true, ++this.data.page) }, setListHeight: function () { let systemInfo = wx.getSystemInfoSync(), rpx = systemInfo.windowWidth / 750, tapHeight = Math.floor(rpx * 98), scrollHeight = systemInfo.windowHeight - tapHeight; this.setData({ scrollHeight }) }, })