const App = getApp(); Page({ data: { order_goods_id: null, detail: {}, imageList: [], serviceType: 10, }, disable: false, onLoad: function (options) { this.data.order_goods_id = options.order_goods_id; this.getGoodsDetail() }, getGoodsDetail: function () { let _this = this; App._get('sharing.refund/apply', { order_goods_id: this.data.order_goods_id }, function (result) { _this.setData(result.data) }) }, onSwitchService: function (e) { App.saveFormId(e.detail.formId); this.setData({ serviceType: e.detail.target.dataset.type }) }, onGoodsDetail: function (e) { App.saveFormId(e.detail.formId); wx.navigateTo({ url: '../../../goods/index?goods_id=' + e.detail.target.dataset.id }) }, chooseImage: function (e) { let _this = this, index = e.currentTarget.dataset.index, imageList = _this.data.imageList; App.saveFormId(e.detail.formId); wx.chooseImage({ count: 6 - imageList.length, sizeType: ['original', 'compressed'], sourceType: ['album', 'camera'], success: function (res) { _this.setData({ imageList: imageList.concat(res.tempFilePaths) }) } }) }, deleteImage: function (e) { let dataset = e.currentTarget.dataset, imageList = this.data.imageList; imageList.splice(dataset.imageIndex, 1); this.setData({ imageList }) }, onSubmit: function (e) { let _this = this; if (!e.detail.value.content) { App.showError('申请原因不能为空'); return false } if (_this.disable === true) { return false } _this.disable = true; wx.showLoading({ title: '正在处理...', mask: true }); let postParams = { order_goods_id: _this.data.order_goods_id, type: _this.data.serviceType, content: e.detail.value.content, }; let fromPostCall = function (params) { App._post_form('sharing.refund/apply', params, function (result) { if (result.code === 1) { App.showSuccess(result.msg, function () { wx.navigateTo({ url: "../index" }) }) } else { App.showError(result.msg) } }, false, function () { wx.hideLoading(); _this.disable = false }) }; let imagesLength = _this.data.imageList.length; imagesLength > 0 ? _this.uploadFile(imagesLength, fromPostCall, postParams) : fromPostCall(postParams) }, uploadFile: function (imagesLength, callBack, formData) { let uploaded = []; let i = 0; this.data.imageList.forEach(function (filePath, fileKey) { wx.uploadFile({ url: App.api_root + 'upload/image', filePath: filePath, name: 'iFile', formData: { wxapp_id: App.getWxappId(), token: wx.getStorageSync('token') }, success: function (res) { let result = typeof res.data === "object" ? res.data : JSON.parse(res.data); if (result.code === 1) { uploaded[fileKey] = result.data.file_id } }, complete: function () { i++; if (imagesLength === i) { formData['images'] = uploaded; callBack && callBack(formData) } } }) }) }, })